# 이메일 인증 문제 해결 작업 (2025-01-08)

## 문제 상황
- 이메일 회원가입 후 인증 링크 클릭 시 `otp_expired` 에러 발생
- 에러 URL: `https://www.golfearn.com/?error=access_denied&error_code=otp_expired&error_description=Email+link+is+invalid+or+has+expired`

## 원인 분석

### 1. URL 설정 불일치
- Supabase Site URL: `https://golfearn.com` (www 없음)
- 실제 사이트: `https://www.golfearn.com` (www 있음)
- 이메일 redirect_to에 공백 문자(`%20`)가 포함되어 있었음

### 2. PKCE 인증 방식 문제
- 클라이언트 사이드 회원가입 시 브라우저에 `code_verifier` 저장
- 다른 브라우저/앱에서 이메일 링크 열면 `code_verifier`가 없어서 실패
- 토큰이 `pkce_`로 시작하면 PKCE 방식 사용 중

## 수정 내용

### 새로 생성된 파일

#### `lib/actions/auth.ts`
서버 사이드 인증 액션 생성 (PKCE 우회)
```typescript
- signUp(): 서버에서 회원가입 처리
- signIn(): 로그인 처리
- signOut(): 로그아웃 처리
```

### 수정된 파일

| 파일 | 변경 사항 |
|------|----------|
| `app/(auth)/signup/page.tsx` | 클라이언트 → 서버 액션으로 회원가입 변경 |
| `app/(auth)/login/page.tsx` | Suspense 래핑 + URL 에러 파라미터 한글 처리 |
| `app/auth/callback/route.ts` | 에러 상세 정보 전달 개선, 에러 파라미터 처리 |
| `middleware.ts` | error 파라미터도 /auth/callback으로 리다이렉트 |
| `app/(main)/community/CommunitySearch.tsx` | useSearchParams Suspense 래핑 |
| `app/(main)/market/MarketFilters.tsx` | useSearchParams Suspense 래핑 |

### 에러 메시지 한글화 (login/page.tsx)
```typescript
const errorMessages = {
  'otp_expired': '인증 링크가 만료되었습니다. 다시 회원가입해주세요.',
  'access_denied': '접근이 거부되었습니다.',
  'auth_callback_error': '인증 처리 중 오류가 발생했습니다.',
  'no_code': '인증 코드가 없습니다.',
  'invalid_request': '잘못된 요청입니다.',
}
```

## Supabase 설정 변경

### Authentication → URL Configuration
| 설정 | 값 |
|------|-----|
| Site URL | `https://www.golfearn.com` |
| Redirect URLs | `https://www.golfearn.com/**` |
| | `https://www.golfearn.com/auth/callback` |
| | `https://golfearn.com/**` |
| | `https://golfearn.com/auth/callback` |

### Authentication → Email Provider
- Email OTP Expiration: 86400초 (24시간) - 정상

## Vercel 환경변수

```env
NEXT_PUBLIC_SITE_URL=https://www.golfearn.com
```

## 테스트 방법

1. Supabase **Authentication → Users**에서 기존 테스트 계정 삭제
2. 새 이메일로 회원가입
3. 이메일 수신 확인
4. **중요**: 회원가입했던 **같은 브라우저**에서 이메일 링크 열기
   - 이메일 앱에서 바로 열면 PKCE 실패
   - 링크 복사 → 같은 브라우저에 붙여넣기

## 남은 이슈

### PKCE 제한사항
- 회원가입한 브라우저와 이메일 링크를 여는 브라우저가 같아야 함
- 모바일 이메일 앱에서 링크 클릭 시 다른 브라우저로 열려서 실패할 수 있음

### 향후 검토 사항
1. **이메일 인증 비활성화**: Supabase → Authentication → Providers → Email → "Confirm email" 끄기
2. **Magic Link 방식**: 비밀번호 없이 이메일 링크로만 로그인
3. **소셜 로그인 우선**: 카카오 로그인만 사용

## Git 커밋 내역

```
89d2b3b - Fix auth callback error handling
a1e24c4 - Fix PKCE auth issue with server-side signup
```
